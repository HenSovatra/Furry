{% extends "layouts/base.html" %}
{% load static get_attribute %}

{% block title %} {% if page_title %} {{page_title}} {% else %} Data Tables {% endif %} {% endblock title %} 


{% block extrastyle %}
{# Link your custom CSS file #}
<link rel="stylesheet" href="{% static 'assets/css/tablemodel.css' %}">
{% endblock extrastyle %}

{% block content %}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            {# Main Navigation Tabs (Product, Customer, Order, OrderItem, Billing) #}
            <div class="card mb-4">
                <div class="card-header pb-0" style="position: sticky; top: 0; background-color: white; z-index: 100;">
                    <h6>Select Data Table</h6>
                </div>
                <div class="card-body">
                    <ul class="nav nav-pills nav-fill p-1" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'product' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product" role="tab">
                                Product
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'customer' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=customer" role="tab">
                                Customer
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'order' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order" role="tab">
                                Order
                            </a>
                        </li>
                        {% if 'orderitem' in model_map %}
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'orderitem' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=orderitem" role="tab">
                                OrderItem
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'billing' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=billing" role="tab">
                                Billing
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            {# End Main Navigation Tabs #}
            
            {# Sub-Navigation for Product (Categories) #}
            {% if set_main_item == 'product' %}
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Select Product Category</h6>
                </div>
                <div class="card-body">
                    <ul class="nav nav-pills nav-fill p-1" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'All' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=All" role="tab">
                                All
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Dogs' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Dogs" role="tab">
                                Dogs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Cats' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Cats" role="tab">
                                Cats
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Fish' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Fish" role="tab">
                                Fish
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Birds' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Birds" role="tab">
                                Birds
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}
            {# End Sub-Navigation #}

            <div class="card mb-4">
                <div class="card-header pb-0">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6>{{ page_title }}</h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="#" class="btn bg-gradient-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#addModal">
                                Add New {{ set_main_item|title }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3 align-items-center">
                        <div class="col-md-4 search-bar-container">
                            <div class="d-flex align-items-center mb-3">
                                <label class="form-label me-2 mb-0">Search:</label>
                                <input type="text" class="form-control flex-grow-1" id="searchInput" onkeyup="performLiveSearch()" value="{{ request.GET.search }}">    </div>
                        </div>
                        <div class="col-md-8 d-flex justify-content-end align-items-center">
                            
                            {# Items Per Page Dropdown #}
                            <div class="dropdown me-2">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="pageItemsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Items per page: {{ page_items }}
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="pageItemsDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="changePageItems(10)">10</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="changePageItems(25)">25</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="changePageItems(50)">50</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="changePageItems(100)">100</a></li>
                                </ul>
                            </div>

                            {# Add Filter Button #}
                            <button type="button" class="btn btn-outline-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
                                <i class="fas fa-filter me-1"></i> Add Filter
                            </button>

                            {# Export CSV Button #}
                            <a href="{% url 'Admin:export_csv' set_main_item %}{% if request.GET.search %}?search={{ request.GET.search }}{% endif %}" class="btn btn-success btn-sm me-2">
                                    Export CSV
                                </a>
                        </div>
                    </div>
                    {% if filter_instance %}
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2">
                                {% for filter in filter_instance %}
                                <span class="badge badge-pill badge-lg bg-gradient-info text-white">
                                    {{ filter.key|title|replace:"_, " }}: {{ filter.value }}
                                    <a href="{% url 'Admin:delete_filter' set_main_item filter.id %}" class="text-white ms-1" style="text-decoration: none;">&times;</a>
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    {% include 'admin_app/dyn_dt/items-table.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

{# Add New Item Modal #}
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Add New {{ set_main_item|title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form role="form" method="POST" action="{% url 'Admin:create' set_main_item %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    {# Dynamic fields based on set_main_item #}
                    {% if set_main_item == 'product' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description"></textarea>
                        </div>
                        {# Changed 'price' to 'original_price' and added 'discounted_price' #}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Original Price</label>
                            <input type="number" step="0.01" class="form-control" name="original_price" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Discounted Price</label>
                            <input type="number" step="0.01" class="form-control" name="discounted_price">
                        </div>
                        {# Added 'stock' field #}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Stock</label>
                            <input type="number" class="form-control" name="stock" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="category" required>
                                <option value="">Select Category</option>
                                <option value="1">Dogs</option> {# Assuming Category IDs #}
                                <option value="2">Cats</option>
                                <option value="3">Fish</option>
                                <option value="4">Birds</option>
                                {# You might want to dynamically load categories here from context if you have many #}
                            </select>
                        </div>
                        {# Image Upload Field #}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Image</label>
                            <input type="file" class="form-control" name="image" accept="image/*">
                        </div>
                        <div class="form-check form-switch d-flex align-items-center mb-3">
                            <input class="form-check-input" type="checkbox" id="is_active_add" name="is_active" checked>
                            <label class="form-check-label mb-0 ms-3" for="is_active_add">Is Active</label>
                        </div>
                    {% elif set_main_item == 'customer' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" name="first_name" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="last_name" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone_number">
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address"></textarea>
                        </div>
                    {% elif set_main_item == 'order' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Order Date</label>
                            <input type="date" class="form-control" name="order_date" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" name="total_amount" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    {% elif set_main_item == 'billing' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" name="amount" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Issue Date</label>
                            <input type="date" class="form-control" name="issue_date" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="due_date">
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="unpaid">Unpaid</option>
                                <option value="paid">Paid</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                    {% else %}
                        <p>No fields defined for {{ set_main_item|title }} creation.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn bg-gradient-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Edit Item Modals #}
{% for item in items.object_list %}
<div class="modal fade" id="editSales-{{item.id}}" tabindex="-1" role="dialog" aria-labelledby="editSalesLabel-{{item.id}}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSalesLabel-{{item.id}}">Edit {{ set_main_item|title }} (ID: {{ item.id }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {# IMPORTANT: Updated form action to include item.id and added enctype #}
            <form role="form" method="POST" action="{% url 'Admin:update' set_main_item item.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="id" value="{{ item.id }}">
                <div class="modal-body">
                    {% if set_main_item == 'product' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" value="{{ item.name }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description">{{ item.description }}</textarea>
                        </div>
                        {# Changed 'price' to 'original_price' and added 'discounted_price' #}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Original Price</label>
                            <input type="number" step="0.01" class="form-control" name="original_price" value="{{ item.original_price }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Discounted Price</label>
                            <input type="number" step="0.01" class="form-control" name="discounted_price" value="{{ item.discounted_price|default_if_none:'' }}">
                        </div>
                        {# Added 'stock' field #}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Stock</label>
                            <input type="number" class="form-control" name="stock" value="{{ item.stock }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="category" required>
                                <option value="">Select Category</option>
                                <option value="1" {% if item.category.id == 1 %}selected{% endif %}>Dogs</option>
                                <option value="2" {% if item.category.id == 2 %}selected{% endif %}>Cats</option>
                                <option value="3" {% if item.category.id == 3 %}selected{% endif %}>Fish</option>
                                <option value="4" {% if item.category.id == 4 %}selected{% endif %}>Birds</option>
                            </select>
                        </div>
                        {# Image Upload Field (for update) #}
                            <div class="input-group input-group-outline my-3 focused is-filled">
                                <label class="form-label">Image</label>
                                <input type="file" class="form-control" name="image" accept="image/*">
                                {% if item.image %}
                                    <p class="text-xs mt-1">Current Image: <a href="{{ item.image.url }}" target="_blank">View</a></p>
                                    {# ADD THIS HIDDEN INPUT FIELD #}
                                    <input type="hidden" name="existing_image_url" value="{{ item.image.url }}">
                                {% endif %}
                            </div>
                            <div class="form-check form-switch d-flex align-items-center mb-3 focused is-filled">
                                <input class="form-check-input" type="checkbox" id="is_active_edit_{{item.id}}" name="is_active" {% if item.is_active %}checked{% endif %}>
                                <label class="form-check-label mb-0 ms-3" for="is_active_edit_{{item.id}}">Is Active</label>
                            </div>
                    {% elif set_main_item == 'customer' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" name="first_name" value="{{ item.first_name }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="last_name" value="{{ item.last_name }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="{{ item.email }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone_number" value="{{ item.phone_number|default_if_none:'' }}">
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address">{{ item.address|default_if_none:'' }}</textarea>
                        </div>
                    {% elif set_main_item == 'order' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" value="{{ item.customer.id }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Order Date</label>
                            <input type="date" class="form-control" name="order_date" value="{{ item.order_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" name="total_amount" value="{{ item.total_amount }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="pending" {% if item.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="processing" {% if item.status == 'processing' %}selected{% endif %}>Processing</option>
                                <option value="shipped" {% if item.status == 'shipped' %}selected{% endif %}>Shipped</option>
                                <option value="delivered" {% if item.status == 'delivered' %}selected{% endif %}>Delivered</option>
                                <option value="cancelled" {% if item.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                    {% elif set_main_item == 'billing' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" value="{{ item.customer.id }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" name="amount" value="{{ item.amount }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Issue Date</label>
                            <input type="date" class="form-control" name="issue_date" value="{{ item.issue_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="due_date" value="{{ item.due_date|date:'Y-m-d'|default_if_none:'' }}">
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="unpaid" {% if item.status == 'unpaid' %}selected{% endif %}>Unpaid</option>
                                <option value="paid" {% if item.status == 'paid' %}selected{% endif %}>Paid</option>
                                <option value="overdue" {% if item.status == 'overdue' %}selected{% endif %}>Overdue</option>
                            </select>
                        </div>
                    {% else %}
                        <p>No fields defined for {{ set_main_item|title }} editing.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn bg-gradient-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{# Delete Item Modals #}
{% for item in items.object_list %}
<div class="modal fade" id="deleteSales-{{item.id}}" tabindex="-1" role="dialog" aria-labelledby="deleteSalesLabel-{{item.id}}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSalesLabel-{{item.id}}">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this {{ set_main_item }} (ID: {{ item.id }})?</p>
                <p><strong>Name:</strong> {{ item.name }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancel</button>
                {# IMPORTANT: Updated form action to include item.id #}
                <form role="form" method="POST" action="{% url 'Admin:delete' set_main_item item.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="id" value="{{ item.id }}">
                    <button type="submit" class="btn bg-gradient-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{# Filter Modal #}
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Add Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form role="form" method="POST" action="{% url 'Admin:create_filter' set_main_item %}">
                {% csrf_token %}
                <div class="modal-body" id="inputContainer">
                    {# Existing filters (if any) #}
                    {% for filter in filter_instance %}
                    <div class="input-container d-flex align-items-center gap-3 mb-3">
                        <div class="d-flex gap-2 w-100">
                            <select name="key" class="form-select w-50">
                                {% for field in db_filters %}
                                <option value="{{ field }}" {% if filter.key == field %}selected{% endif %}>{{ field|title|replace:"_, " }}</option>
                                {% endfor %}
                            </select>
                            <input name="value" class="form-control" type="text" placeholder="Enter value" value="{{ filter.value }}">
                        </div>
                        <button class="remove-button btn mb-0 btn-danger" onclick="removeInputContainer(this)">X</button>
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn bg-gradient-info" id="addFilterButton">Add Another Filter</button>
                    <button type="submit" class="btn bg-gradient-primary" id="submitButton" {% if not filter_instance %}style="display:none;"{% endif %}>Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>




{% endblock content %}

{% block extra_js %}
<script>
    // --- Material Dashboard Input Styling Functions (KEEP THESE AS IS) ---
    function focused(element) {
        const inputGroup = element.parentElement;
        if (inputGroup.classList.contains('input-group-outline')) {
            if (element.hasAttribute('value') && element.value !== '') {
                inputGroup.classList.add('is-filled');
            } else {
                inputGroup.classList.remove('is-filled');
            }
        }
        if (inputGroup.classList.contains('input-group-static')) {
            if (element.hasAttribute('value') && element.value !== '') {
                inputGroup.classList.add('is-filled');
            } else {
                inputGroup.classList.remove('is-filled');
            }
        }
        inputGroup.classList.toggle('focused');
    }

    function defocused(element) { // Ensure defocused is also defined and correctly interacts with Material Dashboard
        const inputGroup = element.parentElement;
        inputGroup.classList.toggle('focused');
        if (inputGroup.classList.contains('input-group-outline') || inputGroup.classList.contains('input-group-static')) {
            if (element.value === '') {
                inputGroup.classList.remove('is-filled');
            }
        }
    }

    // --- Core Live Search Functionality ---
    let searchTimeoutId; // Renamed to avoid potential global conflicts

    // This function will be called on 'keyup' event
    function performLiveSearch() {
        // Clear any previous timeout to reset the debounce timer
        clearTimeout(searchTimeoutId);

        // Set a new timeout to run the search logic after a brief delay (e.g., 300ms)
        searchTimeoutId = setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) {
                console.error('Error: Search input element (ID "searchInput") not found.');
                return; // Stop if the input isn't found
            }

            const searchValue = searchInput.value.toLowerCase().trim(); // Get value, convert to lowercase, remove leading/trailing spaces

            // Use a more specific selector for the table body to avoid conflicts
            const tableBody = document.querySelector('.card-body.px-0.pt-0.pb-2 table tbody');
            if (!tableBody) {
                console.error('Error: Table body element not found. Check the HTML structure: .card-body.px-0.pt-0.pb-2 table tbody');
                return; // Stop if the table body isn't found
            }

            const rows = tableBody.getElementsByTagName('tr');

            // If no search value, show all rows and exit
            if (searchValue === '') {
                for (let i = 0; i < rows.length; i++) {
                    rows[i].style.display = ''; // Show all rows
                }
                console.log('Search cleared: Showing all rows.');
                return;
            }

            let visibleRowCount = 0;
            for (let i = 0; i < rows.length; i++) {
                let row = rows[i];
                // *** MODIFIED LINE HERE: Target the product name specifically ***
                // Find the <h6> element within the first <td> of the current row
                const productNameElement = row.querySelector('td:first-child h6.mb-0.text-sm');

                if (!productNameElement) {
                    // console.warn('Product name element not found in row. Skipping row for search.', row);
                    continue; // Skip this row if name element isn't found
                }

                let nameText = productNameElement.textContent.toLowerCase(); // Get only the name's text

                if (nameText.includes(searchValue)) {
                    row.style.display = ''; // Show the row
                    visibleRowCount++;
                } else {
                    row.style.display = 'none'; // Hide the row
                }
            }
            console.log(`Live Search (by Name): "${searchValue}" - Found ${visibleRowCount} matching rows.`);

        }, 300); // 300 milliseconds debounce delay
    }

    // --- Dynamic Filter Addition/Removal in Modals (KEEP THESE AS IS) ---
    // (Your existing code for addFilterButton and removeInputContainer)
    var fieldNames = [
        {% for field in db_filters %}
            "{{ field }}",
        {% endfor %}
    ];

    document.getElementById('addFilterButton')?.addEventListener('click', function() {
        if (typeof fieldNames === 'undefined' || fieldNames.length === 0) {
            console.error("Error: 'fieldNames' is not defined or empty. Cannot add filter.");
            alert("Filter fields are not loaded. Please ensure 'fieldNames' variable is available and populated.");
            return;
        }

        var template = `
            <div class="input-container d-flex align-items-center gap-3 mb-3">
                <div class="d-flex gap-2 w-100">
                    <select name="key" class="form-select w-50">
                        ${fieldNames.map(option => `<option value="${option}">${option.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</option>`).join('')}
                    </select>
                    <input name="value" class="form-control" type="text" placeholder="Enter value">
                </div>
                <button class="remove-button btn mb-0 btn-danger" onclick="removeInputContainer(this)">X</button>
            </div>
        `;
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = template;
        document.getElementById('inputContainer').appendChild(tempDiv);
        document.getElementById('submitButton').style.display = 'inline-block';
    });

    function removeInputContainer(element) {
        var inputContainer = element.closest('.input-container');
        inputContainer.remove();
        
        var inputContainers = document.getElementsByClassName('input-container');
        if (inputContainers.length === 0) {
            // Optionally hide submit button if no filters are left
            // document.getElementById('submitButton').style.display = 'none';
        }
    }

    // --- Event Listener Setup (MODIFIED to include Edit/Delete) ---
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            // Attach the search function to the keyup event
            searchInput.addEventListener('keyup', performLiveSearch);

            // Optional: Run search on page load if the input already has a value (e.g., from browser history/autofill)
            if (searchInput.value.length > 0) {
                performLiveSearch();
            }

            // Ensure Material Dashboard's 'is-filled' class is correctly applied on load
            const inputGroup = searchInput.closest('.input-group-outline');
            if (inputGroup && searchInput.value !== '') {
                inputGroup.classList.add('is-filled');
            } else if (inputGroup && searchInput.value === '') {
                inputGroup.classList.remove('is-filled');
            }
        } else {
            console.error('Initial setup: Search input element (ID "searchInput") not found.');
        }


        
        // NEW JAVASCRIPT FOR EDIT AND DELETE BUTTONS - INTEGRATED HERE
        const tableBody = document.querySelector('.table.align-items-center.mb-0 tbody');


        if (tableBody) {
            tableBody.addEventListener('click', function(event) {
                const editButton = event.target.closest('.edit-btn');
                if (editButton) {
                    event.preventDefault(); // Prevent default link behavior (e.g., jumping to top)

                    const modalId = editButton.dataset.bsTarget; // Get the target modal ID, e.g., "#editSales-123"

                    if (modalId && document.querySelector(modalId)) {
                        // Ensure Bootstrap's Modal class is available
                        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                            const myModal = new bootstrap.Modal(document.querySelector(modalId));
                            myModal.show();
                            console.log(`Successfully attempted to open modal: ${modalId}`);
                        } else {
                            console.error('Bootstrap Modal JavaScript not found. Make sure Bootstrap JS is loaded.');
                        }
                    } else {
                        console.error(`Modal element not found with ID: ${modalId}`);
                    }
                }
const deleteButton = event.target.closest('.delete-btn');
                if (deleteButton) {
                    event.preventDefault(); // Prevent default link behavior
                    const itemId = deleteButton.dataset.itemId;
                    const modelName = deleteButton.dataset.modelName;

                    if (confirm(`Are you sure you want to delete this ${modelName} (ID: ${itemId})?`)) {
                        const deleteUrl = deleteButton.dataset.deleteUrl;

                        // Get CSRF token from a hidden input, assuming there's one in a form on the page
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                        fetch(deleteUrl, {
                            method: 'DELETE', // Use DELETE method for deletion
                            headers: {
                                'X-CSRFToken': csrfToken, // Include CSRF token for Django
                                'Content-Type': 'application/json' // Indicate content type, even if body is empty
                            }
                            // No body is typically needed for DELETE by ID
                        })
                        .then(response => {
                            if (response.ok) { // Check for 2xx status codes (200 OK, 204 No Content)
                                alert(`${modelName} (ID: ${itemId}) deleted successfully!`);
                                // Reload the page to reflect the changes in the table
                                window.location.reload();
                            } else {
                                // Handle API errors (e.g., 404 Not Found, 403 Forbidden, 400 Bad Request)
                                response.text().then(text => {
                                    alert(`Failed to delete ${modelName} (ID: ${itemId}): ${text || response.statusText}`);
                                    console.error('Delete error response:', text);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error during fetch delete:', error);
                            alert('An error occurred during deletion. Check console for details.');
                        });
                    }
                }
            });
        }
    }); // End of DOMContentLoaded
</script>
{% endblock extra_js %}