{% extends "layouts/base.html" %}
{% load static get_attribute %}

{% block title %} {% if page_title %} {{page_title}} {% else %} Data Tables {% endif %} {% endblock title %} 


{% block extrastyle %}
{# Link your custom CSS file #}
<link rel="stylesheet" href="{% static 'assets/css/tablemodel.css' %}">
{% endblock extrastyle %}

{% block content %}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            {# Main Navigation Tabs (Product, Customer, Order) #}
            <div class="card mb-4">
                <div class="card-header pb-0" style="position: sticky; top: 0; background-color: white; z-index: 100;">
                    <h6>Select Data Table</h6>
                </div>
                <div class="card-body">
                    <ul class="nav nav-pills nav-fill p-1" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'product' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product" role="tab">
                                Product
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'customer' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=customer" role="tab">
                                Customer
                            </a>
                        </li>
                        {# Order as a direct navigation link #}
<li class="nav-item">
    <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_main_item == 'order' %}active{% endif %}"
       href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order" role="tab">
        Order
    </a>
</li>
                    </ul>
                </div>
            </div>
            {# End Main Navigation Tabs #}
            
            {# Sub-Navigation for Product (Categories) #}
            {% if set_main_item == 'product' %}
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Select Product Category</h6>
                </div>
                <div class="card-body">
                    <ul class="nav nav-pills nav-fill p-1" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'All' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=All" role="tab">
                                All
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Dogs' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Dogs" role="tab">
                                Dogs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Cats' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Cats" role="tab">
                                Cats
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Fish' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Fish" role="tab">
                                Fish
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Birds' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Birds" role="tab">
                                Birds
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Pet Foods' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Pet Foods" role="tab">
                                Pet Foods
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if set_category == 'Pet Clothes' %}active{% endif %}"
                               href="{% url 'Admin:dynamic_dt_overview' %}?main_item=product&category=Pet Clothes" role="tab">
                                Pet Clothes
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}
            {# End Sub-Navigation #}

{% if set_main_item == 'order' %}
<div class="card mb-4">
    <div class="card-header pb-0">
        <h6>Filter Orders by Status</h6>
    </div>
    <div class="card-body">
        <ul class="nav nav-pills nav-fill p-1" role="tablist">
            <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if request.GET.status == 'All' or not request.GET.status %}active{% endif %}"
                   href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order&status=All" role="tab">
                    All Orders
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if request.GET.status == 'Pending' %}active{% endif %}"
                   href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order&status=Pending" role="tab">
                    Pending
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if request.GET.status == 'Processing' %}active{% endif %}"
                   href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order&status=Processing" role="tab">
                    Processing
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if request.GET.status == 'Shipped' %}active{% endif %}"
                   href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order&status=Shipped" role="tab">
                    Shipped
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if request.GET.status == 'Delivered' %}active{% endif %}"
                   href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order&status=Delivered" role="tab">
                    Delivered
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center {% if request.GET.status == 'Cancelled' %}active{% endif %}"
                   href="{% url 'Admin:dynamic_dt_overview' %}?main_item=order&status=Cancelled" role="tab">
                    Cancelled
                </a>
            </li>
        </ul>
    </div>
</div>
{% endif %}


            <div class="card mb-4">
                <div class="card-header pb-0">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6>{{ page_title }}</h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="#" class="btn bg-gradient-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#addModal">
                                Add New {{ set_main_item|title }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3 align-items-center">
                        <div class="col-md-4 search-bar-container">
                            <div class="d-flex align-items-center mb-3">
                                <label class="form-label me-2 mb-0">Search:</label>
                                <input type="text" class="form-control flex-grow-1" id="searchInput" onkeyup="performLiveSearch()" value="{{ request.GET.search }}">    </div>
                        </div>
                        <div class="col-md-8 d-flex justify-content-end align-items-center">

    {# Items Per Page Dropdown #}
    <div class="dropdown me-2">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="pageItemsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Items per page: {{ page_items }}
        </button>
        <ul class="dropdown-menu" aria-labelledby="pageItemsDropdown">
            <li><a class="dropdown-item" href="#" onclick="changePageItems(10)">10</a></li>
            <li><a class="dropdown-item" href="#" onclick="changePageItems(25)">25</a></li>
            <li><a class="dropdown-item" href="#" onclick="changePageItems(50)">50</a></li>
            <li><a class="dropdown-item" href="#" onclick="changePageItems(100)">100</a></li>
        </ul>
    </div>

    

    

    {# Add Filter Button #}
    <button type="button" class="btn btn-outline-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
        <i class="fas fa-filter me-1"></i> Add Filter
    </button>

    {# Export CSV Button #}
    <a href="{% url 'Admin:export_csv' set_main_item %}{% if request.GET.search %}?search={{ request.GET.search }}{% endif %}" class="btn btn-success btn-sm me-2">
            Export CSV
        </a>
</div>
                    {% if filter_instance %}
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2">
                                {% for filter in filter_instance %}
                                <span class="badge badge-pill badge-lg bg-gradient-info text-white">
                                    {{ filter.key|title|replace:"_, " }}: {{ filter.value }}
                                    <a href="{% url 'Admin:delete_filter' set_main_item filter.id %}" class="text-white ms-1" style="text-decoration: none;">&times;</a>
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="table-responsive p-0">
                        {% if set_main_item == 'customer' %}
                            {% include 'admin_app/dyn_dt/items-table-customer.html' %}
                        {% elif set_main_item == 'order' %}
                            {% include 'admin_app/dyn_dt/items-table-order.html' %}
                        {% else %} {# This will load items-table.html for 'product' and any other unspecified main_items #}
                            {% include 'admin_app/dyn_dt/items-table.html' with model_name=set_main_item %}
                        {% endif %}
                    </div>
            </div>
        </div>
    </div>
</div>

{# Add New Item Modal #}
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Add New {{ set_main_item|title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form role="form" method="POST" action="{% url 'Admin:create' set_main_item %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    {# Dynamic fields based on set_main_item #}
                    {% if set_main_item == 'product' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description"></textarea>
                        </div>
                        {# Changed 'price' to 'original_price' and added 'discounted_price' #}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Original Price</label>
                            <input type="number" step="0.01" class="form-control" name="original_price" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Discounted Price</label>
                            <input type="number" step="0.01" class="form-control" name="discounted_price">
                        </div>
                        {# Added 'stock' field #}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Stock</label>
                            <input type="number" class="form-control" name="stock" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="category" required>
                                <option value="">Select Category</option>
                                {# Dynamically load categories from context if available, otherwise hardcode #}
                                {% comment %}
                                    Assuming you pass `categories` in your context from the view:
                                    {% for cat in categories %}
                                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                                    {% endfor %}
                                {% endcomment %}
                                <option value="1">Dogs</option> {# Assuming Category IDs and Names #}
                                <option value="2">Cats</option>
                                <option value="3">Fish</option>
                                <option value="4">Birds</option>
                                <option value="5">Pet Foods</option>
                                <option value="6">Pet Clothes</option>
                            </select>
                        </div>
                        {# Image Upload Field #}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Image</label>
                            <input type="file" class="form-control" name="image" accept="image/*">
                        </div>
                        <div class="form-check form-switch d-flex align-items-center mb-3">
                            <input class="form-check-input" type="checkbox" id="is_active_add" name="is_active" checked>
                            <label class="form-check-label mb-0 ms-3" for="is_active_add">Is Active</label>
                        </div>
                    {% elif set_main_item == 'customer' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" name="confirm_password" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" name="first_name">
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="last_name">
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone_number">
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address"></textarea>
                        </div>
                    {% elif set_main_item == 'order' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Order Date</label>
                            <input type="date" class="form-control" name="order_date" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" name="total_amount" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    {% elif set_main_item == 'orderitem' %}
                        {# Fields for OrderItem creation #}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Order ID</label>
                            <input type="number" class="form-control" name="order" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Product ID</label>
                            <input type="number" class="form-control" name="product" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" name="price" required>
                        </div>
                    {% elif set_main_item == 'billing' %}
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" name="amount" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Issue Date</label>
                            <input type="date" class="form-control" name="issue_date" required>
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="due_date">
                        </div>
                        <div class="input-group input-group-outline my-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="unpaid">Unpaid</option>
                                <option value="paid">Paid</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                    {% else %}
                        <p>No fields defined for {{ set_main_item|title }} creation.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn bg-gradient-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Edit Item Modals #}
{% for item in items.object_list %}
<div class="modal fade" id="editSales-{{item.id}}" tabindex="-1" role="dialog" aria-labelledby="editSalesLabel-{{item.id}}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSalesLabel-{{item.id}}">Edit {{ set_main_item|title }} (ID: {{ item.id }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {# IMPORTANT: Updated form action to include item.id and added enctype #}
            <form role="form" method="POST" action="{% url 'Admin:update' set_main_item item.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="id" value="{{ item.id }}">
                <div class="modal-body">
                    {% if set_main_item == 'product' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" value="{{ item.name }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description">{{ item.description }}</textarea>
                        </div>
                        {# Changed 'price' to 'original_price' and added 'discounted_price' #}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Original Price</label>
                            <input type="number" step="0.01" class="form-control" name="original_price" value="{{ item.original_price }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Discounted Price</label>
                            <input type="number" step="0.01" class="form-control" name="discounted_price" value="{{ item.discounted_price|default_if_none:'' }}">
                        </div>
                        {# Added 'stock' field #}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Stock</label>
                            <input type="number" class="form-control" name="stock" value="{{ item.stock }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="category" required>
                                <option value="">Select Category</option>
                                {# Dynamically load categories from context if available, otherwise hardcode #}
                                {% comment %}
                                    Assuming you pass `categories` in your context from the view:
                                    {% for cat in categories %}
                                        <option value="{{ cat.id }}" {% if item.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                                    {% endfor %}
                                {% endcomment %}
                                <option value="1" {% if item.category.name == 'Dogs' %}selected{% endif %}>Dogs</option>
                                <option value="2" {% if item.category.name == 'Cats' %}selected{% endif %}>Cats</option>
                                <option value="3" {% if item.category.name == 'Fish' %}selected{% endif %}>Fish</option>
                                <option value="4" {% if item.category.name == 'Birds' %}selected{% endif %}>Birds</option>
                                <option value="5" {% if item.category.name == 'Pet Foods' %}selected{% endif %}>Pet Foods</option>
                                <option value="6" {% if item.category.name == 'Pet Clothes' %}selected{% endif %}>Pet Clothes</option>
                            </select>
                        </div>
                        {# Image Upload Field (for update) #}
                            <div class="input-group input-group-outline my-3 focused is-filled">
                                <label class="form-label">Image</label>
                                <input type="file" class="form-control" name="image" accept="image/*">
                                {% if item.image %}
                                    <p class="text-xs mt-1">Current Image: <a href="{{ item.image.url }}" target="_blank">View</a></p>
                                    {# ADD THIS HIDDEN INPUT FIELD #}
                                    <input type="hidden" name="existing_image_url" value="{{ item.image.url }}">
                                {% endif %}
                            </div>
                            <div class="form-check form-switch d-flex align-items-center mb-3 focused is-filled">
                                <input class="form-check-input" type="checkbox" id="is_active_edit_{{item.id}}" name="is_active" {% if item.is_active %}checked{% endif %}>
                                <label class="form-check-label mb-0 ms-3" for="is_active_edit_{{item.id}}">Is Active</label>
                            </div>
                    {% elif set_main_item == 'customer' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" name="first_name" value="{{ item.first_name }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="last_name" value="{{ item.last_name }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="{{ item.email }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone_number" value="{{ item.phone_number|default_if_none:'' }}">
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address">{{ item.address|default_if_none:'' }}</textarea>
                        </div>
                    {% elif set_main_item == 'order' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" value="{{ item.customer.id }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Order Date</label>
                            <input type="date" class="form-control" name="order_date" value="{{ item.order_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" name="total_amount" value="{{ item.total_amount }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="pending" {% if item.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="processing" {% if item.status == 'processing' %}selected{% endif %}>Processing</option>
                                <option value="shipped" {% if item.status == 'shipped' %}selected{% endif %}>Shipped</option>
                                <option value="delivered" {% if item.status == 'delivered' %}selected{% endif %}>Delivered</option>
                                <option value="cancelled" {% if item.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                    {% elif set_main_item == 'orderitem' %}
                        {# Fields for OrderItem editing #}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Order ID</label>
                            <input type="number" class="form-control" name="order" value="{{ item.order.id }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Product ID</label>
                            <input type="number" class="form-control" name="product" value="{{ item.product.id }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" value="{{ item.quantity }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" name="price" value="{{ item.price }}" required>
                        </div>
                    {% elif set_main_item == 'billing' %}
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Customer ID</label>
                            <input type="number" class="form-control" name="customer" value="{{ item.customer.id }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" name="amount" value="{{ item.amount }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Issue Date</label>
                            <input type="date" class="form-control" name="issue_date" value="{{ item.issue_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="due_date" value="{{ item.due_date|date:'Y-m-d'|default_if_none:'' }}">
                        </div>
                        <div class="input-group input-group-outline my-3 focused is-filled">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="unpaid" {% if item.status == 'unpaid' %}selected{% endif %}>Unpaid</option>
                                <option value="paid" {% if item.status == 'paid' %}selected{% endif %}>Paid</option>
                                <option value="overdue" {% if item.status == 'overdue' %}selected{% endif %}>Overdue</option>
                            </select>
                        </div>
                    {% else %}
                        <p>No fields defined for {{ set_main_item|title }} editing.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn bg-gradient-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{# Delete Item Modals #}
{% for item in items.object_list %}
<div class="modal fade" id="deleteSales-{{item.id}}" tabindex="-1" role="dialog" aria-labelledby="deleteSalesLabel-{{item.id}}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSalesLabel-{{item.id}}">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this {{ set_main_item }} (ID: {{ item.id }})?</p>
                {# Display relevant name/identifier for confirmation #}
                {% if set_main_item == 'product' %}
                    <p><strong>Name:</strong> {{ item.name }}</p>
                {% elif set_main_item == 'customer' %}
                    <p><strong>Name:</strong> {{ item.first_name }} {{ item.last_name }}</p>
                {% elif set_main_item == 'order' %}
                    <p><strong>Order ID:</strong> {{ item.id }} (Customer: {{ item.customer.first_name }} {{ item.customer.last_name }})</p>
                {% elif set_main_item == 'orderitem' %}
                    <p><strong>Order Item ID:</strong> {{ item.id }} (Product: {{ item.product.name }})</p>
                {% elif set_main_item == 'billing' %}
                    <p><strong>Billing ID:</strong> {{ item.id }} (Customer: {{ item.customer.first_name }} {{ item.customer.last_name }})</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancel</button>
                {# IMPORTANT: Updated form action to include item.id #}
                <form role="form" method="POST" action="{% url 'Admin:delete' set_main_item item.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="id" value="{{ item.id }}">
                    <button type="submit" class="btn bg-gradient-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{# Filter Modal #}
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Add Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form role="form" method="POST" action="{% url 'Admin:create_filter' set_main_item %}">
                {% csrf_token %}
                <div class="modal-body" id="inputContainer">
                    {# Existing filters (if any) #}
                    {% for filter in filter_instance %}
                    <div class="input-container d-flex align-items-center gap-3 mb-3">
                        <div class="d-flex gap-2 w-100">
                            <select name="key" class="form-select w-50">
                                {% for field in db_filters %}
                                <option value="{{ field }}" {% if filter.key == field %}selected{% endif %}>{{ field|title|replace:"_, " }}</option>
                                {% endfor %}
                            </select>
                            <input name="value" class="form-control" type="text" placeholder="Enter value" value="{{ filter.value }}">
                        </div>
                        <button class="remove-button btn mb-0 btn-danger" onclick="removeInputContainer(this)">X</button>
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn bg-gradient-info" id="addFilterButton">Add Another Filter</button>
                    <button type="submit" class="btn bg-gradient-primary" id="submitButton" {% if not filter_instance %}style="display:none;"{% endif %}>Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>




{% endblock content %}
{% block extra_js %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    function focused(element) {
        const inputGroup = element.parentElement;
        if (inputGroup.classList.contains('input-group-outline')) {
            if (element.hasAttribute('value') && element.value !== '') {
                inputGroup.classList.add('is-filled');
            } else {
                inputGroup.classList.remove('is-filled');
            }
        }
        if (inputGroup.classList.contains('input-group-static')) {
            if (element.hasAttribute('value') && element.value !== '') {
                inputGroup.classList.add('is-filled');
            } else {
                inputGroup.classList.remove('is-filled');
            }
        }
        inputGroup.classList.toggle('focused');
    }

    function defocused(element) { 
        const inputGroup = element.parentElement;
        inputGroup.classList.toggle('focused');
        if (inputGroup.classList.contains('input-group-outline') || inputGroup.classList.contains('input-group-static')) {
            if (element.value === '') {
                inputGroup.classList.remove('is-filled');
            }
        }
    }

    let searchTimeoutId; 

    function performLiveSearch() {
        clearTimeout(searchTimeoutId);
        searchTimeoutId = setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) {
                console.error('Error: Search input element (ID "searchInput") not found.');
                return; 
            }

            const searchValue = searchInput.value.toLowerCase().trim(); 
            const tableBody = document.getElementById('products-table');
            if (!tableBody) {
                console.error('Error: Table body element not found. Check the HTML structure: .card-body.px-0.pt-0.pb-2 table tbody');
                return; 
            }

            const rows = tableBody.getElementsByTagName('tr');

            if (searchValue === '') {
                for (let i = 0; i < rows.length; i++) {
                    rows[i].style.display = ''; 
                }
                console.log('Search cleared: Showing all rows.');
                return;
            }

            let visibleRowCount = 0;
            for (let i = 0; i < rows.length; i++) {
                let row = rows[i];
                const productNameElement = row.querySelector('td:first-child h6.mb-0.text-sm');

                if (!productNameElement) {
                    continue; 
                }

                let nameText = productNameElement.textContent.toLowerCase(); 

                if (nameText.includes(searchValue)) {
                    row.style.display = ''; 
                    visibleRowCount++;
                } else {
                    row.style.display = 'none'; 
                }
            }
            console.log(`Live Search (by Name): "${searchValue}" - Found ${visibleRowCount} matching rows.`);

        }, 300); 
    }

    var fieldNames = [
        {% for field in db_filters %}
            "{{ field }}",
        {% endfor %}
    ];

    document.getElementById('addFilterButton')?.addEventListener('click', function() {
        if (typeof fieldNames === 'undefined' || fieldNames.length === 0) {
            console.error("Error: 'fieldNames' is not defined or empty. Cannot add filter.");
            alert("Filter fields are not loaded. Please ensure 'fieldNames' variable is available and populated.");
            return;
        }

        var template = `
            <div class="input-container d-flex align-items-center gap-3 mb-3">
                <div class="d-flex gap-2 w-100">
                    <select name="key" class="form-select w-50">
                        ${fieldNames.map(option => `<option value="${option}">${option.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</option>`).join('')}
                    </select>
                    <input name="value" class="form-control" type="text" placeholder="Enter value">
                </div>
                <button class="remove-button btn mb-0 btn-danger" onclick="removeInputContainer(this)">X</button>
            </div>
        `;
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = template;
        document.getElementById('inputContainer').appendChild(tempDiv);
        document.getElementById('submitButton').style.display = 'inline-block';
    });

    function removeInputContainer(element) {
        var inputContainer = element.closest('.input-container');
        inputContainer.remove();
        
        var inputContainers = document.getElementsByClassName('input-container');
        if (inputContainers.length === 0) {
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', performLiveSearch);

            if (searchInput.value.length > 0) {
                performLiveSearch();
            }

            const inputGroup = searchInput.closest('.input-group-outline');
            if (inputGroup && searchInput.value !== '') {
                inputGroup.classList.add('is-filled');
            } else if (inputGroup && searchInput.value === '') {
                inputGroup.classList.remove('is-filled');
            }
        } else {
            console.error('Initial setup: Search input element (ID "searchInput") not found.');
        }


        
        const tableBody = document.querySelector('.table.align-items-center.mb-0 tbody');


        if (tableBody) {
            tableBody.addEventListener('click', function(event) {
                
        const deleteButton = event.target.closest('.delete-btn');
                if (deleteButton) {
                    event.preventDefault(); 
                    const itemId = deleteButton.dataset.itemId;
                    const modelName = deleteButton.dataset.modelName;

                    if (confirm(`Are you sure you want to delete this ${modelName} (ID: ${itemId})?`)) {
                        const deleteUrl = deleteButton.dataset.deleteUrl;

                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                        fetch(deleteUrl, {
                            method: 'POST', 
                            headers: {
                                'X-CSRFToken': csrfToken, 
                                'Content-Type': 'application/x-www-form-urlencoded' 
                            },
                            body: `id=${itemId}&_method=DELETE` 
                        })
                        .then(response => {
                            if (response.ok) { 
                                alert(`${modelName} (ID: ${itemId}) deleted successfully!`);
                                window.location.reload();
                            } else {
                                response.text().then(text => {
                                    alert(`Failed to delete ${modelName} (ID: ${itemId}): ${text || response.statusText}`);
                                    console.error('Delete error response:', text);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error during fetch delete:', error);
                            alert('An error occurred during deletion. Check console for details.');
                        });
                    }
                }
            });
        }
    }); 

    function changePageItems(numItems) {
        let currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('page_items', numItems);
        currentUrl.searchParams.set('page', 1); 
        window.location.href = currentUrl.toString();
    }
</script>
{% endblock extra_js %}